library(dplyr)

# pasta com dados de GPS
source <- "F:/Dados/SMTR"

# lendo dados
stops <- readr::read_csv("data-raw/stops_sample.csv")

stop_times <- readr::read_csv("data-raw/stop_times_sample.csv")

trips <- readr::read_csv("data-raw/trips_sample.csv")

shapes_geom <- readr::read_csv("data-raw/shapes_geom_sample.csv")

routes <- readr::read_csv("data-raw/routes_sample.csv")

# mantendo apenas algumas colunas

stops <- stops %>%
    select(
        stop_id, stop_lat, stop_lon
    )

stop_times <- stop_times %>%
    select(
        trip_id, stop_id, stop_sequence, shape_dist_traveled
    )

trips <- trips %>%
    select(
        trip_id, route_id, direction_id, shape_id
    )

shapes_geom <- shapes_geom %>%
    select(
        shape_id, shape_distance, start_pt, end_pt
    )

routes <- routes %>%
    select(
        route_id, "servico" = route_short_name
    )

# juntando todas as informacoes do gtfs:
# objetivo é uma base a nivel de serviço, para
# mergear com gps

# primeiro montando uma base com todas as paradas por trip

gtfs <- trips %>%
    right_join(stop_times, by = "trip_id")

# identificando o serviço de cada viagem

gtfs <- gtfs %>%
    left_join(routes, by = "route_id")

# agregando a base para nível servico-direction-stop

gtfs <- gtfs %>%
    select(-trip_id) %>%
    distinct()

# adicionando coordenadas de cada ponto

gtfs <- gtfs %>%
    left_join(stops, by = "stop_id")

# adicionando shapefile das rotas

gtfs <- gtfs %>%
    left_join(shapes_geom, by = "shape_id")

# salvando

readr::write_rds(gtfs, "data/gtfs.rds")
