---
title: "R Notebook"
output: html_notebook
---

```{r, message = FALSE, warning = FALSE}
library(basedosdados)
library(dplyr)
library(ggplot2)
library(knitr)
library(fixest)
library(data.table)
library(randomForest)

# projeto google cloud
set_billing_id("absolute-text-417919") 

# caminho para os dados mais pesados
source <- "F:/Dados/SMTR"
```

Lendo os dados: base de treino, de 04/03/2024 a 08/03/2024 (dias de semana), e base de teste, de 11/03/2024 a 12/04/2024. Tiro outliers com tempo de chegada acima de 1h e distância ao próximo ponto acima de 1km.

```{r, message = FALSE}
training_data <- fread(file.path(source, "gps_training_1_10.csv"))

test_data <- fread(file.path(source, "gps_test_1_10.csv"))
```

## Medidas de erro

* Erro quadrático médio

\[
\mathrm{MSE} = \frac{1}{n}\sum_i \big(y_i - \widehat{y}_i\big)^2, \quad \mathrm{RMSE} = \sqrt{\mathrm{MSE}}.
\]

* Erro absoluto médio

\[
\mathrm{MAE} = \frac{1}{n}\sum_i \big\lvert y_i - \widehat{y}_i\big\rvert.
\]

* Erro Absoluto Percentual Médio

\[
\mathrm{MAPE} = \frac{1}{n}\sum_i \frac{\lvert y_i - \widehat{y}_i\rvert}{y_i}.
\]

* Desvio absoluto mediano

\[
\mathrm{MAD} = \mathrm{median}\Big(\big\lvert e_i - \mathrm{median}(e_i)\big\rvert\Big), \quad\text{onde $e_i = y_i - \widehat{y}_i$}.
\]

## Benchmark: médias de chegada de cada linha

\[
\widehat{y}_i = \text{média de tempos de chegada do serviço ao ponto}
\]

```{r, echo = FALSE}
# setup da tabela que armazena os resultados

models <- data.frame(
    "Modelo" = character(), "RMSE" = double(), "MAE" = double(), "MAPE" = double(), "MAD" = double()
)

# função que produz medidas de erro

prediction_errors <- function(df, modelo) {
    by_stop <- df %>%
        mutate(error = arrival_time - est_arrival_time) %>%
        summarise(
            Modelo = modelo,
            RMSE = sqrt(mean(error^2, na.rm = TRUE)),
            MAE = mean(abs(error), na.rm = TRUE),
            MAPE = mean(abs(error)/arrival_time, na.rm = TRUE),
            MAD = median(abs(error - median(error, na.rm = TRUE)), na.rm = TRUE),
            .by = "stop_order"
        ) %>%
        arrange(stop_order) %>%
        rename("Ordem do ponto" = stop_order) %>%
        mutate(across(`Ordem do ponto`, as.character))
    
    total <- df %>%
        mutate(error = arrival_time - est_arrival_time) %>%
        summarise(
            `Ordem do ponto` = "Total",
            Modelo = modelo,
            RMSE = sqrt(mean(error^2, na.rm = TRUE)),
            MAE = mean(abs(error), na.rm = TRUE),
            MAPE = mean(abs(error)/arrival_time, na.rm = TRUE),
            MAD = median(abs(error - median(error, na.rm = TRUE)), na.rm = TRUE)
        )
    
    bind_rows(total, by_stop)
}
```


```{r, echo = FALSE}
bench <- training_data %>%
    summarise(
        est_arrival_time = mean(arrival_time, na.rm = TRUE),
        .by = c("servico", "stop_id", "stop_order")
    )

bench <- test_data %>%
    left_join(bench, by = c("servico", "stop_id", "stop_order"))

bench <- prediction_errors(bench, "Médias históricas")

models <- models %>%
    bind_rows(bench[1,])

kable(bench, digits = 1)
```


## Modelo Newtoniano

\[
\widehat{y}_i = \frac{\text{distância até o próx. ponto}}{\text{velocidade média últimos 10mins}}
\]

```{r, echo = FALSE}
newton <- test_data %>%
    mutate(
        est_arrival_time = 60/1000 * dist_to_stop/velocidade_estimada_10_min
    )

newton <- prediction_errors(newton, "Newtoniano")

models <- models %>%
    bind_rows(newton[1,])

kable(newton, digits = 1)
```

## Regressão linear

\[
\log(\widehat{y}_i) = \alpha + \beta\,\log(\text{distância}) + \gamma\,\log(v_\text{10mins}) + \delta\, \log(v_\text{inst} + 1)
\]

```{r, echo = FALSE}
reg_newton <- lm(
    log(arrival_time) ~ log(dist_to_stop) + log(velocidade_estimada_10_min) 
    + log(velocidade_instantanea + 1),
    data = training_data
)

reg_newton <- test_data %>%
    bind_cols("est_arrival_time" = predict(reg_newton, test_data)) %>%
    mutate(error = (arrival_time - est_arrival_time)) %>%
    prediction_errors("Regressão simples")

models <- models %>%
    bind_rows(reg_newton[1,])

kable(reg_newton, digits = 1)
```

## Regressão com Efeitos Fixos

\[
\log(\widehat{y}_i) = \alpha_{\text{serviço, ponto}} + \beta\,\log(\text{distância}) + \gamma\,\log(\text{velocidade 10mins})
\]

```{r, echo = FALSE}
training_data <- training_data %>%
    mutate(hora = stringr::str_split(hora, ":", simplify = TRUE) %>% {.[,1]})

test_data <- test_data %>%
    mutate(hora = stringr::str_split(hora, ":", simplify = TRUE) %>% {.[,1]})

# Estimando

fe_reg <- feols(
    log(arrival_time) ~ log(dist_to_stop) + log(velocidade_estimada_10_min) 
    + log(velocidade_instantanea + 1) | servico^stop_id,
    data = training_data,
    combine.quick = FALSE
)

# Calculando performance

fe_reg <- test_data %>%
    bind_cols("est_arrival_time" = predict(fe_reg, test_data)) %>%
    prediction_errors("EF de serviço-ponto")

models <- models %>%
    bind_rows(fe_reg[1,])

kable(fe_reg, digits = 1)
```

## Regressão com Efeitos Fixos incluindo horários

\[
\log(\widehat{y}_i) = \alpha_{\text{serviço, ponto}} + \alpha_{\text{hora, ponto}} + \beta\,\log(\text{distância}) + \gamma\,\log(\text{velocidade 10mins})
\]

```{r, echo = FALSE}
# Estimando

fe_reg_hora <- feols(
    log(arrival_time) ~ log(dist_to_stop) + log(velocidade_estimada_10_min)
    + log(velocidade_instantanea + 1) | servico^stop_id + stop_id^hora,
    data = training_data,
    combine.quick = FALSE
)

# Calculando performance

fe_reg_hora <- test_data %>%
    bind_cols("est_arrival_time" = predict(fe_reg_hora, test_data)) %>%
    prediction_errors("EF de serviço-ponto e ponto-hora")

models <- models %>%
    bind_rows(fe_reg_hora[1,])

kable(fe_reg_hora, digits = 1)
```

## Random Forest

```{r, message = FALSE}
training_data <- training_data %>%
    mutate(across(hora, as.numeric)) %>%
    mutate(across(stop_id, as.factor))

test_data <- test_data %>%
    mutate(across(hora, as.numeric)) %>%
    mutate(across(stop_id, as.factor))

training_subset <- training_data %>%
    slice_sample(prop = 0.05)

y <- training_subset %>%
    select(arrival_time) %>%
    unlist()

x <- training_subset %>%
    select(
        hora, latitude, longitude,
        velocidade_instantanea, velocidade_estimada_10_min, distancia,
        dist_traveled_shape, dist_to_stop, stop_order
    ) %>%
    as.matrix()

rf <- randomForest(
    x = x, y = y,
    proximity = FALSE,
    keep.forest = TRUE,
    importance = TRUE,
    do.trace = TRUE,
    ntree = 1000,
    maxnodes = 24
)

x_test <- test_data %>%
    select(
        hora, latitude, longitude,
        velocidade_instantanea, velocidade_estimada_10_min, distancia,
        dist_traveled_shape, dist_to_stop, stop_order
    )

rf <- test_data %>%
    bind_cols("est_arrival_time" = predict(rf, x_test)) %>%
    prediction_errors("Random Forest")

models <- models %>%
    bind_rows(rf[1,])

kable(rf, digits = 1)
```

## Comparativo

```{r}
kable(models, digits = 1)
```


